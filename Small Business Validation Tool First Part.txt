%let PROCHTTP_PROXY=;
filename json_in "/data/bbm/data/sasdata/sasuser/Billy/json_input.txt";
filename out "/data/bbm/data/sasdata/sasuser/Billy/fonoa_response.txt";
libname wholeurl "/data/bbm/data/sasdata/sasuser/Billy";

proc import datafile='/data/bbm/data/sasdata/sasuser/Billy/Sample_2 for Fonoa API.xlsx'
                  out=Samples_for_Fonoa DBMS=xlsx replace;
run;
      
data json_to_request (keep=tax_identification_numbers);
set Samples_for_Fonoa (rename= (Business_ID=tax_identification_numbers));
run;

data _null_;
set json_to_request end=eof;
      count+1;
      if eof then call symputx("total_numbers_record", count);
run;

%macro fonoa_url (tin);
proc json out="/data/bbm/data/sasdata/sasuser/Billy/json_input.txt" pretty keys nosastags;
      write open object;
            write values "country_iso_code" "ca";
            write values "tax_identification_number" "&tin";
      write close;
run;

proc http
   url="https://api-demo.fonoa.com/Lookup/v2/single-validations"
   method=post
   ct="application/json"
   in=json_in
   out=out
   timeout=30;
   headers "Accept"="application/json";
   headers "Ocp-Apim-Subscription-Key"="";
run;

/*data _null_;*/
/*infile out;*/
/*input;*/
/*put _infile_;*/
/*run;*/

proc import datafile = '/data/bbm/data/sasdata/sasuser/Billy/fonoa_response.txt'
      out = fonoa_response
      dbms = dlm
      replace;
      getnames = no;
      delimiter = ',';
run;

data url(drop=var1-var8);
set fonoa_response;
      STATUS = substr(var1, 12,length(var1)-12);
      TIN = substr(var2, 44,length(var2)-44);
      COUNTRY_ISO_CODE = substr(var3, 21, length(var3)-21);
      REQUESTED_DATE = substr(var4, 17, length(var4)-17);
      VALIDATION_ID = substr(var5, 18, length(var5)-18);
      FORMAT = substr(var6, 11, length(var6)-11);
      IS_BUSINESS = substr(var7, 16, length(var7)-17);
      URL = substr(var8, 26,length(var8)-27);
run;

proc append base = Whole_fonoa_returned_url
            data = url force;
run;

data wholeurl.Whole_fonoa_returned_url;
set Whole_fonoa_returned_url;
run;
%mend;

%macro url_loop;
      %do counter=1 %to (&total_numbers_record);
      data _null_;
      set json_to_request;
            if _n_ = &counter;
            call symput ("tin_number", tax_identification_numbers);
      run;

      %fonoa_url (&tin_number);
      %end;
%mend;
%url_loop;
